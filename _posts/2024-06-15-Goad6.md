---
layout: single
title: Game of Active Directory - Parte 6
excerpt: "En esta sexta parte vamos a atacar el servidor kingslanding.sevenkingdoms.local, que es el controlador de dominio de sevenkingdoms.local. Nos aprovecharemos de la relación de confianza bidireccional que tiene con el dominio essos.local que, en este caso está configurado con la opción sid-history. Esto nos permitirá crear un golden ticket con acceso total al dominio sevenkingdoms.local y podremos hacer un dcsync obteniendo el hash del administrador."
date: 2024-06-15
classes: wide
header:
  teaser: /assets/images/Goad/logo_GOAD.jpg
  teaser_home_page: true
categories:
  - Ciberseguridad
tags:
  - Windows
  - Active Directory
---

![](/assets/images/Goad/logo_GOAD.jpg)


En esta sexta parte vamos a atacar el servidor kingslanding.sevenkingdoms.local, que es el controlador de dominio de sevenkingdoms.local. Nos aprovecharemos de la relación de confianza bidireccional que tiene con el dominio essos.local que, en este caso está configurado con la opción sid-history. Esto nos permitirá crear un golden ticket con acceso total al dominio sevenkingdoms.local y podremos hacer un dcsync obteniendo el hash del administrador.


## Un poco de teoría necesaria

El SID es un identificador único que se asigna a cada objeto (usuario,grupo.equipo) y se utiliza para identificarlo dentro de un dominio y para controlar el acceso a los recursos.

El SID-history es un apropiedad de un usuario u objeto de grupo que permite que el objeto conserve su SID cuando se migra de un dominio a otro. Cuando un objeto se migra a un nuevo dominio, se le asigna un nuevo SID en el dominio de destino. El SID-history permite que el objeto conserve su SID original, de modo que no se pierda el acceso a los recursos en el dominio de origen. Por ejemplo cuando una empresa A adquiere otra empresa B, pero los usuarios de la empresa A necesitan continuar accediendo a los recursos del dominio origen.

Además existe el concepto de filtrado de SID, que de estar habilitado en una confianza, impide que el SID-history haga su trabajo. Pero hay ciertos escenarios, como el que vamos a explotar, en el que algunos SID no se filtran, y se permite el SID-history en los objetos con RID mayor que 1000.

## Enumerando las confianzas entre dominios

Vamos a enumerar las relaciones de confianza que hay configuradas en nuestro laboratorio GOAD. Para ello podemos utilizar diferentes herramientas.

### BloodHound

Con bloodhound podemos ver que existe una relación de confianza bidireccional entre essos.local y sevenkingdoms.local, además también vemos que hay otra relación de confianza entre north.sevenkingdoms.local y sevenkingdoms.local, pero esta es del tipo padre-hijo, ya que los dos dominios pertenecen al mismo bosque, y es otro vector de explotación.

![](/assets/images/Goad/trusts.jpg)


### Netexec

Con Netexec también podemos enumerar las relaciones de confianza ya que tenemos el hash del administrador del dominio essos.local.

```bash
nxc ldap 192.168.56.12 -u Administrator -H 54296a48cd30259cc88095373cec24da -M enum_trusts
```

![](/assets/images/Goad/nxc_trusts.jpg)


### Ldeep

Con la herramienta ldeep podemos enumerar las relaciones de confianza tanto en un sentido como en el otro, aprovechando que tenemos el hash NTLM del administrador del dominio essos.local, lo que la hace la mejor opción.

```bash
ldeep ldap -u administrator -H aad3b435b51404eeaad3b435b51404ee:54296a48cd30259cc88095373cec24da -d essos.local -s ldap://192.168.56.12 trusts
```
```bash
ldeep ldap -u administrator -H aad3b435b51404eeaad3b435b51404ee:54296a48cd30259cc88095373cec24da -d essos.local -s ldap://192.168.56.10 trusts
```

Podemos ver que en el sentido sevenkingdoms --> essos nos muestra TREAT_AS_EXTERNAL, lo cual significa que el SID-history está funcionando.

![](/assets/images/Goad/external.jpg)



