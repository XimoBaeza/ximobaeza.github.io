---
layout: single
title: Smb Relay
excerpt: "En este artículo me he montado un pequeño laboratorio con dos máquinas windows 11 unidas a un controlador de dominio con windows server 2022, para recrear una auditoría interna en la que empezamos con la captura de credenciales usando la herramienta responder, para luego hacer un reenvío de esas credenciales a la segunda máquina, obtener acceso a ésta, ver las credenciales guardadas en el navegador, hacer un volcado de memória del proceso lsass.exe y transferirlo a nuestro equipo, para ver las credenciales del administrador del dominio con pypykatz y conectarnos al servidor con evil-winrm. Además explicaré como se puede mitigar el smb relay a través de gpo en el controlador de dominio."
date: 2022-10-08
classes: wide
header:
  teaser: /assets/images/Smb-Relay/responder2.png
  teaser_home_page: true
categories:
  - Ciberseguridad
tags:
  - Windows
  - Privilege Escalation
  - Pentesting
---

En este artículo me he montado un pequeño laboratorio con dos máquinas windows 11 unidas a un controlador de dominio con windows server 2022, para recrear una auditoría interna en la que empezamos con la captura de credenciales usando la herramienta responder, para luego hacer un reenvío de esas credenciales a la segunda máquina, obtener acceso a ésta, ver las credenciales guardadas en el navegador, hacer un volcado de memória del proceso lsass.exe y transferirlo a nuestro equipo, para ver las credenciales del administrador del dominio con pypykatz y conectarnos al servidor con evil-winrm. Además explicaré como se puede mitigar el smb relay a través de gpo en el controlador de dominio.

## Descripción del laboratorio

### Controlador de dominio
 - SO: Windows Server 2022 Standard
 - Nombre: DC1
 - IP: 192.168.0.100
 - Dominio: SIETEREINOS.LOCAL

 ![](/assets/images/Smb-Relay/DC1.PNG)


### Equipo 1
 - SO: Windows 11 Profesional
 - Nombre: PC01
 - IP: 192.168.0.202
 - Usuario: SIETEREINOS\Jon (Jon Nieve)

![](/assets/images/Smb-Relay/PC01.png)

### Equipo 2
 - SO: Windows 11 Profesional
 - Nombre: PC02
 - IP: 192.168.0.169
 - Usuario: SIETEREINOS\Arya (Arya Stark)

![](/assets/images/Smb-Relay/PC02.png)

### Máquina atacante
 - Linux debian con todas las herramientas necesarias instaladas (responder, ntlmrelayx, proxychains, DonPapi, hoaxshell, pypykatz y evil-winrm)

## Introducción

En entornos corporativos windows es muy común el uso de mecanismos de resolución de nombres basados en broadcast (LLMNR - Local Link Multicast Name Resolution, NBT-NS - NetBIOS Naming Services) y la activación por defecto de IPv6 en los servidores y estaciones de trabajo.

LLMNR y NBT-NS son mecanismos a los que el sistema operativo recurre de forma automática cuando a través de DNS no se obtiene ningún resultado. Es decir, que cada vez que se produce una petición de red por cualquier equipo, en la que el destino no existe se recurre a ellos, haciendo una petición broadcast a toda la red, y si la petición no va firmada, se confiará en cualquier respuesta que se reciba. Estas peticiones se producen muy a menudo por tareas de backup obsoletas, y otras tareas automatizadas que hacen peticiones a equipos que en ese momento estén apagados, por ejemplo, un servidor de actualizaciones que intenta actualizar un equipo que está apagado, un equipo que intenta conectar una unidad de red que ya no existe, o una impresora que ya no está compartida, por poner algunos ejemplos. Es en este punto cuando entra en juego la herramienta responder, que ante una petición de este tipo se va a hacer pasar por el recurso capturando las credenciales en formato hash netntlm, y si la contraseña es debil se podrá crackear fácilmente.

Además es posible hacer un reenvío de esas credenciales hacia otros equipos, y en el caso de que tengan privilegios sobre ese otro equipo podemos ganar acceso a ese segundo equipo. En este artículo veremos solo algunos ejemplos de como un atacante que ha logrado acceso a la red interna con, por ejemplo un phising o instalando un dispositivo físico para conectarse desde fuera, podría aprovecharse de ello.

## Captura de credenciales con Responder

Lo primero es enumerar los equipos que hay en la red y ver si tienen el smb firmado o si utilizan smb1 con crackmapexec (cme smb 192.168.0.0/24)

![](/assets/images/Smb-Relay/cme.png)

Vemos mucha información útil. El nombre de los equipos, el dominio, y también vemos que en el servidor el smb está firmado pero en los dos equipos restantes no. Y que ninguno de los 3 utiliza smb1.

Empezamos con la captura de credenciales con responder. Tan solo tenemos que poner en marcha el responder y esperar una petición a un recurso compartido que no exista.

El comando es responder -I enp3s0 -v

![](/assets/images/Smb-Relay/responder.png)

